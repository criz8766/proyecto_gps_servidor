# .woodpecker.yml (Versión Final con Despliegue Seguro)

when:
  branch: main
  event: push

steps:
  # ... (tus tres pasos de build se quedan exactamente igual) ...

  build_pacientes:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      registry: ghcr.io
      repo: ghcr.io/criz8766/proyecto_gps_servidor/pacientes
      username: criz8766
      password: { from_secret: GITHUB_PAT }
      context: pacientes
      dockerfile: pacientes/Dockerfile
      tags:
        - latest
        - ${COMMIT_SHA}

  build_inventario:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      registry: ghcr.io
      repo: ghcr.io/criz8766/proyecto_gps_servidor/inventario
      username: criz8766
      password: { from_secret: GITHUB_PAT }
      context: inventario
      dockerfile: inventario/Dockerfile
      tags:
        - latest
        - ${COMMIT_SHA}

  build_frontend:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      registry: ghcr.io
      repo: ghcr.io/criz8766/proyecto_gps_servidor/frontend
      username: criz8766
      password: { from_secret: GITHUB_PAT }
      context: frontend
      dockerfile: frontend/Dockerfile
      tags:
        - latest
        - ${COMMIT_SHA}

  # --- ESTE ES EL PASO QUE VAMOS A CORREGIR ---
  deploy:
    image: appleboy/drone-ssh
    settings:
      host: 192.168.0.29
      username: arcci
      key: { from_secret: SERVIDOR_PRODUCCION_SSH }
      script:
        - cd /home/arcci/Descargas/proyecto_gps_servidor/proyecto_gps
        - git pull origin main
        - echo "==> Iniciando sesión en GHCR..."
        - cat ~/.github-pat | docker login ghcr.io -u criz8766 --password-stdin
        - echo "==> Descargando las nuevas imágenes..."
        - docker-compose -f docker-compose.prod.yml pull
        - echo "==> Reiniciando servicios con las nuevas imágenes..."
        # Este es el comando seguro: reinicia solo lo necesario sin destruir todo.
        - docker-compose -f docker-compose.prod.yml up -d --remove-orphans
        - echo "==> Limpiando imágenes antiguas..."
        - docker image prune -af